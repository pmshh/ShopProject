<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <div th:replace="/layouts/defaultLayout.html :: head"></div>
</head>

<body>
    <main>
        <div th:replace="/layouts/defaultLayout.html :: sidebar"></div>

        <article class="content">
            <div th:replace="/layouts/defaultLayout.html :: nav"></div>

            <!-- review_enroll section -->
            <section id="review_enroll">
                <div class="container-fluid review_enroll">
                    <div class="section_header">
                        <h2>리뷰 등록</h2>
                        <div class="divider"></div>
                    </div>
                    <div class="review_enroll_body mt-5">

                        <!-- item_info_wrap start -->
                        <div class="item_info_wrap" th:if="${#strings.isEmpty(review)}">
                                <span class="thumbnail">
                                    <a class="item_link" style="pointer-events: none">
                                        <img class="no_img" src="/imgs/no_image.jpg">
                                    </a>
                                </span>
                            <div class="information">
                                <button id="test" class="white_btn_w90_h40 find_item_btn">상품정보선택</button>
                            </div>
                        </div>
                        <div class="item_info_wrap" th:if="${not #strings.isEmpty(review)}">
                            <input type="hidden" class="hiddenItemId" th:value="${review.itemId}">
                            <span class="thumbnail">
                                    <a th:href="${'/item/' + review.itemId}">
                                        <img class="item_img" th:src="${review.imgUrl}">
                                    </a>
                                </span>
                            <div class="information">
                                <h3>
                                    <a th:href="${'/item/' + review.itemId}" th:text="${review.itemNm}"></a>
                                </h3>
                                <div class="price">
                                    <span class="price" th:unless="${review.discount > 0}"
                                          th:text="|${#numbers.formatInteger(review.price, 0, 'COMMA')}원|"></span>
                                    <span class="beforePrice" th:if="${review.discount > 0}"
                                          th:text="|${#numbers.formatInteger(review.price, 0, 'COMMA')}원|"></span>
                                    <span class="salePrice" th:if="${review.discount > 0}"
                                          th:text="|${#numbers.formatInteger(review.salePrice, 0, 'COMMA')}원|"></span>
                                </div>
                                <button class="white_btn_w90_h40 new_find_item_btn">상품정보선택</button>
                            </div>
                        </div>

                        <!-- review_form_wrap start -->
                        <div class="review_form_wrap">
                            <form id="reviewEnrollForm" th:action="@{'/review/enroll'}" th:object="${reviewDto}"
                                  method="post">
                                <table>
                                    <colgroup>
                                        <col style="width:15%;">
                                        <col style="width: auto;">
                                    </colgroup>
                                    <tbody>
                                    <tr>
                                        <th scope="row">
                                            <label th:for="*{title}">제목 <span>*</span></label>
                                        </th>
                                        <td>
                                            <input class="title_input" type="text" th:field="*{title}">
                                            <span class="text-danger title_warn">제목을 입력해주세요.</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row">
                                            <label th:for="*{rating}">평점 <span>*</span></label>
                                        </th>
                                        <td>
                                            <select th:field="*{rating}">
                                                <option value="0.5">0.5</option>
                                                <option value="1.0">1.0</option>
                                                <option value="1.5">1.5</option>
                                                <option value="2.0">2.0</option>
                                                <option value="2.5">2.5</option>
                                                <option value="3.0">3.0</option>
                                                <option value="3.5">3.5</option>
                                                <option value="4.0">4.0</option>
                                                <option value="4.5">4.5</option>
                                                <option value="5.0">5.0</option>
                                            </select>
                                            <span class="text-danger title_warn">평점을 입력해주세요.</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row">
                                            <label th:for="*{content}">내용 <span>*</span></label>
                                        </th>
                                        <td>
                                            <textarea class="content_input" th:field="*{content}"></textarea>
                                            <span class="text-danger content_warn">내용을 입력해주세요.</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row">
                                            <label th:for="*{password}">비밀번호 <span>*</span></label>
                                        </th>
                                        <td>
                                            <input class="password_input" th:field="*{password}" type="password">
                                            <span class="text-danger password_warn">비밀번호를 입력해주세요.</span>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>

                                <div class="btn_box">
                                    <button class="black_btn_w130_h40 enroll_btn" type="button">등록</button>
                                    <button class="white_btn_w130_h40 del_btn" type="button">취소</button>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </section>

            <div th:replace="/layouts/defaultLayout.html :: footer"></div>
        </article>
    </main>

    <div th:replace="/layouts/defaultLayout.html :: commonJs"></div>
    <!-- 사용자 JS -->
    <script th:inline="javascript">
        $(function () {
            /* 상품 검색 버튼 */
            $(".find_item_btn").on("click", function (e) {
                e.preventDefault();

                let popUrl = "/review/itemList";
                let popOption = "width=600px, height=500px,top=300px, left=300px, scrollbars=yes";

                window.open(popUrl, "findItem", popOption);
            });

            /* 동적으로 생성된 상품 검색 버튼 */
            $(document).on("click", ".new_find_item_btn", function (e) {
                e.preventDefault();

                let popUrl = "/review/itemList";
                let popOption = "width=600px, height=500px,top=300px, left=300px, scrollbars=yes";

                window.open(popUrl, "findItem", popOption);
            });

            /* 리뷰 등록 버튼 */
            $(".enroll_btn").on("click", function () {
                let itemId = $(".hiddenItemId").val();

                let param = {
                    itemId: itemId,
                    title: $(".title_input").val(),
                    rating: $(".rating_select").val(),
                    content: $(".content_input").val(),
                    password: $(".password_input").val()
                }
                let paramData = JSON.stringify(param);

                $.ajax({
                    url: "/review/enroll",
                    type: "POST",
                    contentType: "application/json",
                    dataType: "text",
                    cache: false,
                    data: paramData,
                    success: function (result, status) {
                        alert(result);
                        location.href = '/reviews';
                    },
                    error: function (request, status, error) {
                        if (request.status === '401') {
                            alert('로그인 후 이용해주세요.');
                            location.href = '/login';
                        } else {
                            alert(request.responseText);
                        }
                    },
                });
            });

            /* 취소 버튼 */
            $(".cancel_btn").on("click", function () {
                window.history.back();
            });
        });
    </script>
</body>
</html>