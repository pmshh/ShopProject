<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <div th:replace="/layouts/defaultLayout.html :: head"></div>

    <style>
        /* item_list_title */
        .item_list_title {
            padding: 12px 35px 12px 19px;
            color: #fff;
            background: #222;
        }
        .item_list_title h1 {
            font-size: 14px;
            line-height: 1.5;
        }

        /* item_list_body */
        .item_list_body {
            padding: 20px;
            font-size: 12px;
        }

        /* item_list_body -> search_form */
        .item_list_body .search_form .search_box {
            padding: 20px;
            margin: 0 auto;
            border: 1px solid #e5e5e5;
            color: #404040;
            text-align: center;
        }
        .item_list_body .search_form .search_box select {
            height: 30px;
            min-height: 30px;
            border: 1px solid #ddd;
            padding: 0 20px 0 10px;
            vertical-align: middle;
        }
        .item_list_body .search_form .search_box input {
            width: 240px;
            height: 30px;
            vertical-align: middle;
            line-height: 24px;
            padding: 2px 4px;
            border: 1px solid #ddd;
            color: #353535;
            font-size: 12px;
        }
        .item_list_body .search_form .search_box button {
            font-size: 12px;
        }

        .item_list_body .search_form .result_box {
            overflow: hidden;
            margin: 10px 0 0;
            padding: 10px 0;
            text-align: right;
            line-height: 30px;
        }
        .item_list_body .search_form .result_box p {
            margin: 0;
            padding: 0;
        }
        .item_list_body .search_form .result_box .total {
            float: left;
            color: #222;
        }
        .item_list_body .search_form .result_box .total strong {
            font-weight: bold;
        }
        .item_list_body .search_form .result_box .limit select {
            height: 30px;
            line-height: 29px;
            min-height: 30px;
            border: 1px solid #ddd;
            padding: 0 20px 0 10px;
            background: white;
        }

        /* item_list_body -> item_list_box */
        .item_list_body .item_list_box table {
            margin: 10px 0 0;
            border-top: 1px solid #e5e5e5;
            border-bottom: 1px solid #e5e5e5;
            font-size: 12px;
            letter-spacing: 0.0em;
            width: 100%;
        }
        .item_list_body .item_list_box table thead {}
        .item_list_body .item_list_box table thead tr {}
        .item_list_body .item_list_box table thead tr th {
            padding: 9px 0 8px;
            border-bottom: 1px solid #e5e5e5;
            color: #353535;
            text-align: center;
            vertical-align: middle;
            font-weight: normal;
        }

        .item_list_body .item_list_box table tbody {}
        .item_list_body .item_list_box table tbody.center {
            text-align: center;
        }
        .item_list_body .item_list_box table tbody tr {}
        .item_list_body .item_list_box table tbody tr td {
            border-top: 1px solid #e5e5e5;
            padding: 15px 10px 14px;
        }
        .item_list_body .item_list_box table tbody tr td span.itemNm {
            display: block;
            margin-bottom: 5px;
        }
        .item_list_body .item_list_box table tbody tr td span.salePrice {
            margin-left: 3px;
        }
        .item_list_body .item_list_box table tbody tr .thumb img {
            max-width: 78px;
            border: 1px solid #d6d6d6;
            vertical-align: middle;
        }
        .item_list_body .item_list_box table tbody tr .left {
            padding-left: 20px;
            text-align: left;
        }
        .item_list_body .item_list_box table tbody tr td button {
            display: inline-block;
            box-sizing: border-box;
            padding: 4px 8px;
            border-radius: 0;
            font-size: 12px;
            line-height: 18px;
            font-weight: normal;
            vertical-align: middle;
            word-spacing: -0.5px;
            letter-spacing: 0;
            text-align: center;
            white-space: nowrap;
            color: #222;
            width: 40px;
            height: 30px;
        }

    </style>
</head>

<body>
    <div class="item_list_wrap">
        <div class="item_list_title">
            <h1>상품검색</h1>
        </div>
        <div class="item_list_body">

            <!-- search_form start -->
            <form class="search_form">
                <div class="search_box">
                    <select id="search_type" name="search_type">
                        <option value="name">상품명</option>
                    </select>
                    <input type="text" name="searchQuery">
                    <button class="black_btn_w65_h30 search_button">검색하기</button>
                </div>
                <div class="result_box">
                    <p class="total">
                        총 <strong th:text="${items.getTotalElements()}">0</strong>개 의 상품이 검색되었습니다.
                    </p>
                    <p class="limit">
                        <select class="limit">
                            <option value="5">5개씩 보기</option>
                            <option value="10">10개씩 보기</option>
                            <option value="20">20개씩 보기</option>
                            <option value="30">30개씩 보기</option>
                        </select>
                    </p>
                </div>
            </form>

            <!-- item_list_box start -->
            <div class="item_list_box">
                <table>
                    <colgroup>
                        <col style="width: 100px">
                        <col style="width: auto">
                        <col style="width: 80px">
                    </colgroup>
                    <thead>
                    <tr>
                        <th scope="col">상품 이미지</th>
                        <th scope="col">상품 정보</th>
                        <th scope="col">선택</th>
                    </tr>
                    </thead>
                    <tbody class="center">
                    <tr th:each="item, state : ${items.getContent()}">
                        <td class="thumb">
                            <img th:src="${item.imgUrl}">
                        </td>
                        <td class="left">
                            <span class="itemNm" th:text="${item.itemNm}"></span>
                            <span th:if="${item.discount == 0}" class="price" th:text="|${#numbers.formatInteger(item.price, 0, 'COMMA')}원|" style="font-weight: bold"></span>
                            <span th:unless="${item.discount == 0}" class="before_salePrice" th:text="|${#numbers.formatInteger(item.price, 0, 'COMMA')}원|" style="text-decoration: line-through"></span>
                            <span th:unless="${item.discount == 0}" class="salePrice" th:text="|${#numbers.formatInteger((item.price * (1 - item.discount)), 0, 'COMMA')}원|" style="font-weight: bold"></span>

                        </td>
                        <td>
                            <button class="white_btn_w65_h30 pick_btn" onclick="pickItem(this)" th:data-imgUrl="${item.imgUrl}" th:data-itemId="${item.itemId}"
                                    th:data-itemNm="${item.itemNm}" th:data-price="${item.price}" th:data-discount="${item.discount}"
                                    th:data-salePrice="${item.salePrice}">선택</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- pagination start -->
            <div class="def_pagination"
                 th:with="start=${(items.number/maxPage)*maxPage + 1}, end=(${(items.totalPages == 0) ? 1 : (start + (maxPage - 1) < items.totalPages ? start + (maxPage - 1) : items.totalPages)})">
                <ul>
                    <li class="prev" th:classappend="${items.first} ? 'disabled'">
                        <a th:onclick="'javascript:page(0)'">
                            <i class="fa-solid fa-angle-left"></i><i class="fa-solid fa-angle-left"></i>
                        </a>
                    </li>
                    <li class="prev" th:classappend="${items.first} ? 'disabled'">
                        <a th:onclick="'javascript:page(' +  ${items.number - 1} + ')'">
                            <i class="fa-solid fa-angle-left"></i>
                        </a>
                    </li>
                    <li class="page" th:each="page: ${#numbers.sequence(start, end)}"
                        th:classappend="${items.number eq page - 1} ? 'active' : ''">
                        <a th:onclick="'javascript:page(' + ${page - 1} + ')'"
                           th:inline="text">[[${page}]]</a>
                    </li>
                    <li class="next" th:classappend="${items.last} ? 'disabled'">
                        <a th:onclick="'javascript:page(' + ${items.number + 1} + ')'">
                            <i class="fa-solid fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="next" th:classappend="${items.last} ? 'disabled'">
                        <a th:onclick="'javascript:page(' + ${items.totalPages - 1} + ')'">
                            <i class="fa-solid fa-angle-right"></i><i
                                class="fa-solid fa-angle-right"></i>
                        </a>
                    </li>
                </ul>
            </div>

        </div>
    </div>

    <script th:inline="javascript">
        $(function() {
            /* 검색어, 상품 검색 개수 값 유지 */
            let searchQuery = [[${searchQuery}]];
            if (searchQuery === 'null') {
                searchQuery = '';
            }
            $("input[name='searchQuery']").val(searchQuery);
            let size = [[${size}]];
            $("#limit").val(size).prop("selected", true);

            /* 검색 버튼 */
            $(".search_button").on("click", function (e) {
                e.preventDefault();
                let selectVal = $(".limit option:selected").val();
                let searchQuery = $("input[name='searchQuery']").val();
                if (searchQuery === '') {
                    alert("검색어를 입력해주세요.")
                    return false;
                }
                location.href = "/board/review/itemList?searchQuery=" + searchQuery + "&size=" + selectVal;
            });

            /* 선택 버튼 */
            $(".pick_btn").on("click", function () {
                let imgUrl = $(this).attr("data-imgUrl");
                let itemId = $(this).attr("data-itemId");
                let itemNm = $(this).attr("data-itemNm");
                let price = $(this).attr("data-price");
                let formatPrice = price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                let discount = $(this).attr("data-discount");
                let salePrice = $(this).attr("data-salePrice");
                let formatSalePrice = salePrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")

                // 기존 info 정보 삭제
                $(opener.document).find(".thumbnail").remove();
                $(opener.document).find(".information").remove();
                $(opener.document).find(".hiddenItemId").remove();

                // 새로운 info 정보 추가
                let newTag = "<span class='thumbnail'>";
                newTag +=       "<a href=/item/" + itemId + ">";
                newTag +=           "<img class='item_img' src=" + imgUrl + ">"
                newTag +=       "</a>"
                newTag +=   "</span>"
                newTag +=   "<div class='information'>";
                newTag +=       "<h3>";
                newTag +=           "<a href=/item/" + itemId + ">" + itemNm + "</a>";
                newTag +=       "</h3>";
                newTag +=       "<div class='price'>";
                if(discount > 0) {
                    newTag +=       "<span class='beforePrice'>" + formatPrice + "원</span>";
                    newTag +=       "<span class='salePrice'>" + formatSalePrice + "원</span>";
                } else {
                    newTag +=       "<span class='price'>" + formatPrice + "원</span>";
                }
                newTag +=       "</div>";
                newTag +=       "<button class='white_btn_w90_h40 new_find_item_btn'>상품정보선택</button>";
                newTag +=   "</div>";
                newTag +=   "<input class='hiddenItemId' type=hidden value=" + itemId + ">";
                $(opener.document).find(".item_info_wrap").append(newTag);

                window.close();
            });

            /* 상품 검색 개수 변경 */
            $(".limit").on("change", function () {
                let selectVal = $("#limit option:selected").val();
                let searchQuery = $("input[name='searchQuery']").val();
                if (searchQuery === '') {
                    searchQuery = null;
                }
                location.href = "/board/review/itemList?searchQuery=" + searchQuery + "&size=" + selectVal;
            });
        });

        /* 페이지 이동 */
        function page(page) {
            let searchQuery = $("input[name='searchQuery']").val();
            let selectVal = $("#limit option:selected").val();
            location.href = "/board/review/itemList?page=" + page + "&searchQuery=" + searchQuery + "&size=" + selectVal;
        }
    </script>
</body>
</html>